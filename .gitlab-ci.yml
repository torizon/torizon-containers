include:
  - "/ci-scripts/release/release.yml"
  - "/ci-scripts/test/aval-tests.yml"
  - "/ci-scripts/test/dotnet-tests.yml"

image: docker:latest

variables:
  DEBIAN_POINT_RELEASE: "12.6-slim"
  TORADEX_INTERNAL_DOCKERHUB_CACHE: "artifactory-horw.int.toradex.com/dockerhub-proxy-no-cache-horw"
  # This should be set by docker image already, just to be sure...
  DOCKER_HOST: tcp://docker:2375
  # Use overlayfs driver for better performance
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2

  DEBIAN_DOCKER_IMAGES_FOLDER: "debian-docker-images"
  SUPPORT_FILES_FOLDER: "support-files"
  IMX8_FOLDER: "imx8"
  AM62_FOLDER: "am62"
  UPSTREAM_FOLDER: "upstream"
  TESTS_FOLDER: "tests"
  CHROMIUM_TESTS_FOLDER: "chromium-tests"
  DEBIAN_CROSS_TOOLCHAINS_FOLDER: "debian-cross-toolchains"
  DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER: "debian-dotnet-development-images"
  SSH_FOLDER: "ssh"
  BASE_FOLDER: "base"
  WAYLAND_BASE_FOLDER: "wayland-base"
  WESTON_FOLDER: "weston"
  GRAPHICS_TESTS_FOLDER: "graphics-tests"
  WESTON_TOUCH_CALIBRATOR_FOLDER: "weston-touch-calibrator"
  QT5_WAYLAND_FOLDER: "qt5-wayland"
  QT6_WAYLAND_FOLDER: "qt6-wayland"
  QT5_WAYLAND_EXAMPLES_FOLDER: "qt5-wayland-examples"
  QT6_WAYLAND_EXAMPLES_FOLDER: "qt6-wayland-examples"
  DOTNET_BASE_FOLDER: "base"
  DOTNET_DEBUG_FOLDER: "debug"
  DOTNET_WAYLAND_BASE_FOLDER: "wayland-base"
  DOTNET_WAYLAND_DEBUG_FOLDER: "wayland-debug"
  RT_VALIDATION_FOLDER: "rt-validation"
  RT_TESTS_FOLDER: "rt-tests"
  STRESS_TESTS_FOLDER: "stress-tests"
  CHROMIUM_FOLDER: "chromium"
  COG_FOLDER: "cog"

services:
  - name: docker:dind

.include-regctl:
  before_script:
    - apk update && apk add curl
    - curl -L https://github.com/regclient/regclient/releases/download/v0.6.0/regctl-linux-amd64 > /usr/bin/regctl
    # to update the hash: download the metadata the regctl repo, verify the signatures, generate the SHA256SUMS file
    # with `sha256sum -b regctl > SHA256SUMS` and update it here.
    - echo "44216c0ab3bd41ae30b07392d6cdab6971f48ab3f72400e617f5f0ded4d70742 /usr/bin/regctl" > SHA256SUMS
    - if ! sha256sum -c SHA256SUMS; then echo "Checksum for regctl has failed"; fi
    - chmod 755 /usr/bin/regctl
    - regctl registry login docker.io -u $DOCKERHUB_USER -p $DOCKERHUB_TOKEN

.do_print_environment_variables: &do_print_environment_variables
  - echo "GitLab CI/CD environment variables:"
  - env

.docker-build:
  variables:
    ADD_TORADEX_REPOSITORY: 1
  script:
    - *do_print_environment_variables
    - apk add curl
    - docker login -u $DOCKERHUB_USER -p $DOCKERHUB_TOKEN
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker info
    - |
      if [[ "${IMAGE_NAME}" == *am62 ]]; then
        export TORADEX_SNAPSHOT=$(curl https://feeds1.toradex.com/debian-am62/snapshots/latest-snapshot)
      else
        export TORADEX_SNAPSHOT=$(curl https://feeds1.toradex.com/debian/snapshots/latest-snapshot)
      fi

    - docker buildx create --name multiarch-builder --driver docker-container --platform linux/arm/v7,linux/arm64/v8,linux/amd64 --use
    - docker buildx inspect --bootstrap
    - docker run --privileged --rm ${TORADEX_INTERNAL_DOCKERHUB_CACHE}/tonistiigi/binfmt --install arm64,arm

    - if [ -n "$BUILD_FOR_ARM_V7" ]; then echo "Building for linux/arm/v7" && PLATFORM_BUILD_ARM_V7="--platform linux/arm/v7"; fi
    - if [ -n "$BUILD_FOR_ARM_V8" ]; then echo "Building for linux/arm64/v8" && PLATFORM_BUILD_ARM_V8="--platform linux/arm64/v8"; fi
    - if [ -n "$BUILD_FOR_AMD64" ]; then echo "Building for linux/amd64" && PLATFORM_BUILD_AMD64="--platform linux/amd64"; fi

    # in MR pipelines, push or manual triggered pipelines on feature branch ~> push image to local registry
    # in protected ref ~> push to DockerHub
    - |
      if [[ "${CI_PIPELINE_SOURCE}" == "merge_request_event" \
          || "${CI_COMMIT_REF_PROTECTED}" == "false" ]]; then
        export PULL_REGISTRY=${CI_REGISTRY}
        export PUSH_REGISTRY=${CI_REGISTRY}
        export REGISTRY_NAMESPACE=${CI_PROJECT_PATH}
        export IMAGE_TAG=${CI_COMMIT_REF_SLUG}-${CI_PIPELINE_ID}
      fi
      if [[ "${CI_COMMIT_REF_PROTECTED}" == "true" ]]; then
        export PULL_REGISTRY=${TORADEX_INTERNAL_DOCKERHUB_CACHE}
        export PUSH_REGISTRY="docker.io"
        export REGISTRY_NAMESPACE=${PROJECT_SETTING_REGISTRY_NAMESPACE}
        export IMAGE_TAG=${CI_COMMIT_BRANCH}
      fi

    - docker buildx build --progress=plain --sbom=true --push ${PLATFORM_BUILD_ARM_V7} ${PLATFORM_BUILD_ARM_V8} ${PLATFORM_BUILD_AMD64}
      --build-arg ACCEPT_FSL_EULA=${ACCEPT_FSL_EULA}
      --build-arg ADD_TORADEX_REPOSITORY=${ADD_TORADEX_REPOSITORY}
      --build-arg BASE_IMAGE_NAME=${BASE_IMAGE_NAME}
      --build-arg BASE_IMAGE_NAME_DEBUG=${BASE_IMAGE_NAME_DEBUG}
      --build-arg BASE_IMAGE_NAME_WAYLAND=${BASE_IMAGE_NAME_WAYLAND}
      --build-arg CROSS_COMPILER=${CROSS_COMPILER}
      --build-arg CROSS_TARGET_ARCH=${CROSS_TARGET_ARCH}
      --build-arg DEBIAN_POINT_RELEASE=${DEBIAN_POINT_RELEASE}
      --build-arg DOTNET_DEBUGGER_VER=${DOTNET_DEBUGGER_VER}
      --build-arg DOTNET_RUNTIME=${DOTNET_RUNTIME}
      --build-arg DOTNET_SEMVER=${DOTNET_SEMVER}
      --build-arg IMAGE_TAG=${IMAGE_TAG}
      --build-arg REGISTRY_PROXY=${TORADEX_INTERNAL_DOCKERHUB_CACHE}
      --build-arg REGISTRY=${PULL_REGISTRY}
      --build-arg REGISTRY_NAMESPACE=${REGISTRY_NAMESPACE}
      --build-arg TORADEX_SNAPSHOT=${TORADEX_SNAPSHOT}
      --label container.name=${IMAGE_NAME}
      --label container.version=${MAJOR}.${MINOR}.${PATCH}
      --label git.branch=${CI_COMMIT_BRANCH}
      --label git.hash=${CI_COMMIT_SHA}
      --label pipeline.id=${CI_PIPELINE_ID}
      -f ${DOCKERFILE_FOLDER}Dockerfile
      -t ${PUSH_REGISTRY}/${REGISTRY_NAMESPACE}/${IMAGE_NAME}:${IMAGE_TAG}
      ${DOCKERFILE_BUILD_CONTEXT_FOLDER}

## debian-docker-images

build-base-imx8:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: &imx8-changes
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/**/*
  before_script:
    - export DEBIAN_POINT_RELEASE="${DEBIAN_POINT_RELEASE}"
  variables:
    BUILD_FOR_ARM_V8: "true"
    IMAGE_NAME: debian-imx8
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${BASE_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/"
  needs: []

build-wayland-base-imx8:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *imx8-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: debian-imx8
    IMAGE_NAME: wayland-base-imx8
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${WAYLAND_BASE_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${WAYLAND_BASE_FOLDER}/"
  needs:
    - job: build-base-imx8
      optional: true

build-weston-imx8:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${WESTON_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${WESTON_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *imx8-changes
  before_script:
    - ./${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${WESTON_FOLDER}/make_feature_map.sh
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: wayland-base-imx8
    IMAGE_NAME: weston-imx8
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${WESTON_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${WESTON_FOLDER}/"
  needs:
    - job: build-wayland-base-imx8
      optional: true

build-graphics-tests-imx8:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${TESTS_FOLDER}/${GRAPHICS_TESTS_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *imx8-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: wayland-base-imx8
    IMAGE_NAME: graphics-tests-imx8
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${TESTS_FOLDER}/${GRAPHICS_TESTS_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${TESTS_FOLDER}/${GRAPHICS_TESTS_FOLDER}/"
  needs:
    - job: build-wayland-base-imx8
      optional: true

build-weston-touch-calibrator-imx8:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${WESTON_TOUCH_CALIBRATOR_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${WESTON_TOUCH_CALIBRATOR_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *imx8-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: weston-imx8
    IMAGE_NAME: weston-touch-calibrator-imx8
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${WESTON_TOUCH_CALIBRATOR_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${WESTON_TOUCH_CALIBRATOR_FOLDER}/"
  needs:
    - job: build-weston-imx8
      optional: true

build-qt5-wayland-imx8:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${QT5_WAYLAND_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *imx8-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: wayland-base-imx8
    IMAGE_NAME: qt5-wayland-imx8
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${QT5_WAYLAND_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/"
  needs:
    - job: build-wayland-base-imx8
      optional: true

build-qt5-wayland-examples-imx8:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${QT5_WAYLAND_EXAMPLES_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${QT5_WAYLAND_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *imx8-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: qt5-wayland-imx8
    IMAGE_NAME: qt5-wayland-examples-imx8
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${QT5_WAYLAND_EXAMPLES_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/"
  needs:
    - job: build-qt5-wayland-imx8
      optional: true

build-qt6-wayland-imx8:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${QT6_WAYLAND_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *imx8-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: wayland-base-imx8
    IMAGE_NAME: qt6-wayland-imx8
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${QT6_WAYLAND_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/"
  needs:
    - job: build-wayland-base-imx8
      optional: true

build-qt6-wayland-examples-imx8:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${QT6_WAYLAND_EXAMPLES_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${QT6_WAYLAND_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *imx8-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: qt6-wayland-imx8
    IMAGE_NAME: qt6-wayland-examples-imx8
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${QT6_WAYLAND_EXAMPLES_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/"
  needs:
    - job: build-qt6-wayland-imx8
      optional: true

build-chromium-imx8:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${CHROMIUM_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${CHROMIUM_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *imx8-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: wayland-base-imx8
    IMAGE_NAME: chromium-imx8
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${CHROMIUM_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${CHROMIUM_FOLDER}/"
  needs:
    - job: build-wayland-base-imx8
      optional: true

build-cog-imx8:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${COG_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${COG_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *imx8-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: wayland-base-imx8
    IMAGE_NAME: cog-imx8
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${COG_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${COG_FOLDER}/"
  needs:
    - job: build-wayland-base-imx8
      optional: true

build-dotnet-8-imx8:
  retry: 2
  extends: .docker-build
  rules: &dotnet-8-imx8-rules
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes: &dotnet-8-imx8-changes
        - gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_BASE_FOLDER}/*
        - ${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_DEBUG_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *imx8-changes
  before_script:
    - . ./ci-scripts/build/export-dotnet-build-args.sh ./ci-scripts/container-versions/dotnet-8.yml dotnet8-imx8
    - export DEBIAN_POINT_RELEASE="${DEBIAN_POINT_RELEASE}"
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: debian-imx8
    IMAGE_NAME: dotnet8-imx8
    DOTNET_RUNTIME: dotnet
    DOCKERFILE_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_BASE_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_BASE_FOLDER}/"
  needs: ["build-base-imx8"]

build-dotnet-8-asp-imx8:
  retry: 2
  extends: .docker-build
  rules: &dotnet-8-asp-imx8-rules
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes: *dotnet-8-imx8-changes
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *imx8-changes
  before_script:
    - . ./ci-scripts/build/export-dotnet-build-args.sh ./ci-scripts/container-versions/dotnet-8.yml aspdotnet8-imx8
    - export DEBIAN_POINT_RELEASE="${DEBIAN_POINT_RELEASE}"
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: debian-imx8
    IMAGE_NAME: aspdotnet8-imx8
    DOTNET_RUNTIME: aspnetcore
    DOCKERFILE_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_BASE_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_BASE_FOLDER}/"
  needs: ["build-base-imx8"]

build-dotnet-8-wayland-imx8:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes: &dotnet-8-wayland-imx8-changes
        - gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${IMX8_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/**/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *imx8-changes
  before_script:
    - . ./ci-scripts/build/export-dotnet-build-args.sh ./ci-scripts/container-versions/dotnet-8.yml dotnet8-wayland-imx8
    - export DEBIAN_POINT_RELEASE="${DEBIAN_POINT_RELEASE}"
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: dotnet8-imx8
    BASE_IMAGE_NAME_WAYLAND: wayland-base-imx8
    IMAGE_NAME: dotnet8-wayland-imx8
    DOCKERFILE_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_WAYLAND_BASE_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_WAYLAND_BASE_FOLDER}/"
  needs: ["build-dotnet-8-imx8", "build-wayland-base-imx8"]

# upstream images

build-base:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: &upstream-changes
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/**/*
  before_script:
    - export DEBIAN_POINT_RELEASE="${DEBIAN_POINT_RELEASE}"
  variables:
    BUILD_FOR_ARM_V7: "true"
    BUILD_FOR_ARM_V8: "true"
    BUILD_FOR_ARM_AMD64: "true"
    IMAGE_NAME: debian
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${BASE_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/"
  needs: []

build-wayland-base:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${WAYLAND_BASE_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *upstream-changes
  variables:
    BUILD_FOR_ARM_V7: "true"
    BUILD_FOR_ARM_V8: "true"
    BUILD_FOR_ARM_AMD64: "true"
    BASE_IMAGE_NAME: debian
    IMAGE_NAME: wayland-base
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${WAYLAND_BASE_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${WAYLAND_BASE_FOLDER}/"
  needs:
    - job: build-base
      optional: true

build-weston:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${WESTON_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${WESTON_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *upstream-changes
  before_script:
    - ./${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${WESTON_FOLDER}/make_feature_map.sh
  variables:
    BUILD_FOR_ARM_V7: "true"
    BUILD_FOR_ARM_V8: "true"
    BUILD_FOR_ARM_AMD64: "true"
    BASE_IMAGE_NAME: wayland-base
    IMAGE_NAME: weston
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${WESTON_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${WESTON_FOLDER}/"
  needs:
    - job: build-wayland-base
      optional: true

build-graphics-tests:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${TESTS_FOLDER}/${GRAPHICS_TESTS_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${WAYLAND_BASE_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *upstream-changes
  variables:
    BUILD_FOR_ARM_V7: "true"
    BUILD_FOR_ARM_V8: "true"
    BUILD_FOR_ARM_AMD64: "true"
    BASE_IMAGE_NAME: wayland-base
    IMAGE_NAME: graphics-tests
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${TESTS_FOLDER}/${GRAPHICS_TESTS_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${TESTS_FOLDER}/${GRAPHICS_TESTS_FOLDER}/"
  needs:
    - job: build-wayland-base
      optional: true

build-weston-touch-calibrator:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${WESTON_TOUCH_CALIBRATOR_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${WESTON_TOUCH_CALIBRATOR_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *upstream-changes
  variables:
    BUILD_FOR_ARM_V7: "true"
    BUILD_FOR_ARM_V8: "true"
    BUILD_FOR_ARM_AMD64: "true"
    BASE_IMAGE_NAME: weston
    IMAGE_NAME: weston-touch-calibrator
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${WESTON_TOUCH_CALIBRATOR_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${WESTON_TOUCH_CALIBRATOR_FOLDER}/"
  needs:
    - job: build-weston
      optional: true

build-qt5-wayland:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${QT5_WAYLAND_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${WAYLAND_BASE_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *upstream-changes
  variables:
    BUILD_FOR_ARM_V7: "true"
    BUILD_FOR_ARM_V8: "true"
    BUILD_FOR_ARM_AMD64: "true"
    BASE_IMAGE_NAME: wayland-base
    IMAGE_NAME: qt5-wayland
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${QT5_WAYLAND_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/"
  needs:
    - job: build-wayland-base
      optional: true

build-qt5-wayland-examples:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${QT5_WAYLAND_EXAMPLES_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${QT5_WAYLAND_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${WAYLAND_BASE_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *upstream-changes
  variables:
    BUILD_FOR_ARM_V7: "true"
    BUILD_FOR_ARM_V8: "true"
    BUILD_FOR_ARM_AMD64: "true"
    BASE_IMAGE_NAME: qt5-wayland
    IMAGE_NAME: qt5-wayland-examples
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${QT5_WAYLAND_EXAMPLES_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/"
  needs:
    - job: build-qt5-wayland
      optional: true

build-qt6-wayland:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${QT6_WAYLAND_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${WAYLAND_BASE_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *upstream-changes
  variables:
    BUILD_FOR_ARM_V7: "true"
    BUILD_FOR_ARM_V8: "true"
    BUILD_FOR_ARM_AMD64: "true"
    BASE_IMAGE_NAME: wayland-base
    IMAGE_NAME: qt6-wayland
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${QT6_WAYLAND_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/"
  needs:
    - job: build-wayland-base
      optional: true

build-chromium:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${CHROMIUM_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${CHROMIUM_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${WAYLAND_BASE_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *upstream-changes
  variables:
    BUILD_FOR_ARM_V7: "true"
    BUILD_FOR_ARM_V8: "true"
    BUILD_FOR_ARM_AMD64: "true"
    BASE_IMAGE_NAME: wayland-base
    IMAGE_NAME: chromium
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${CHROMIUM_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${CHROMIUM_FOLDER}/"
  needs:
    - job: build-wayland-base
      optional: true

build-cog:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${COG_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${COG_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${WAYLAND_BASE_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *upstream-changes
  variables:
    BUILD_FOR_ARM_V7: "true"
    BUILD_FOR_ARM_V8: "true"
    BUILD_FOR_ARM_AMD64: "true"
    BASE_IMAGE_NAME: wayland-base
    IMAGE_NAME: cog
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${COG_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${COG_FOLDER}/"
  needs:
    - job: build-wayland-base
      optional: true

build-dotnet-8:
  retry: 2
  extends: .docker-build
  rules: &dotnet-8-rules
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes: &dotnet-8-changes
        - gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_BASE_FOLDER}/*
        - ${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_DEBUG_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *upstream-changes
  before_script:
    - . ./ci-scripts/build/export-dotnet-build-args.sh ./ci-scripts/container-versions/dotnet-8.yml dotnet8
    - export DEBIAN_POINT_RELEASE="${DEBIAN_POINT_RELEASE}"
  variables:
    BUILD_FOR_ARM_V7: "true"
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: debian
    IMAGE_NAME: dotnet8
    DOTNET_RUNTIME: dotnet
    DOCKERFILE_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_BASE_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_BASE_FOLDER}/"
  needs: ["build-base"]

build-dotnet-8-asp:
  retry: 2
  extends: .docker-build
  rules: &dotnet-8-asp-rules
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes: *dotnet-8-changes
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *upstream-changes
  before_script:
    - . ./ci-scripts/build/export-dotnet-build-args.sh ./ci-scripts/container-versions/dotnet-8.yml aspdotnet8
    - export DEBIAN_POINT_RELEASE="${DEBIAN_POINT_RELEASE}"
  variables:
    BUILD_FOR_ARM_V7: "true"
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: debian
    IMAGE_NAME: aspdotnet8
    DOTNET_RUNTIME: aspnetcore
    DOCKERFILE_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_BASE_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_BASE_FOLDER}/"
  needs: ["build-base"]

build-dotnet-8-wayland:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes: &dotnet-8-wayland-changes
        - gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${UPSTREAM_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/**/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *upstream-changes
  before_script:
    - . ./ci-scripts/build/export-dotnet-build-args.sh ./ci-scripts/container-versions/dotnet-8.yml dotnet8-wayland
    - export DEBIAN_POINT_RELEASE="${DEBIAN_POINT_RELEASE}"
  variables:
    BUILD_FOR_ARM_V7: "true"
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: dotnet8
    BASE_IMAGE_NAME_WAYLAND: wayland-base
    IMAGE_NAME: dotnet8-wayland
    DOCKERFILE_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_WAYLAND_BASE_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_WAYLAND_BASE_FOLDER}/"
  needs: ["build-dotnet-8", "build-wayland-base"]

build-dotnet-8-debug:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes: *dotnet-8-changes
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *upstream-changes
  before_script:
    - . ./ci-scripts/build/export-dotnet-build-args.sh ./ci-scripts/container-versions/dotnet-8.yml dotnet8-debug
  variables:
    BUILD_FOR_ARM_V7: "true"
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: dotnet8
    IMAGE_NAME: dotnet8-debug
    DOCKERFILE_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_DEBUG_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_DEBUG_FOLDER}/"
  needs: ["build-dotnet-8"]

## Debian Cross Toolchains

build-armhf-toolchain:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes: &armhf-toolchain-changes
        - gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_CROSS_TOOLCHAINS_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_CROSS_TOOLCHAINS_FOLDER}/${SSH_FOLDER}/*
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes: *armhf-toolchain-changes
  before_script:
    - export DEBIAN_POINT_RELEASE="${DEBIAN_POINT_RELEASE}"
  variables:
    BUILD_FOR_AMD64: "true"
    CROSS_COMPILER: arm-linux-gnueabihf
    CROSS_TARGET_ARCH: armhf
    IMAGE_NAME: debian-cross-toolchain-armhf
    DOCKERFILE_FOLDER: "${DEBIAN_CROSS_TOOLCHAINS_FOLDER}/${BASE_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_CROSS_TOOLCHAINS_FOLDER}/${BASE_FOLDER}/"
  needs: []

build-armhf-toolchain-ssh:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes: &armhf-toolchain-ssh-changes
        - gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_CROSS_TOOLCHAINS_FOLDER}/${SSH_FOLDER}/*
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes: *armhf-toolchain-ssh-changes
  variables:
    BUILD_FOR_ARM_AMD64: "true"
    IMAGE_NAME: debian-cross-toolchain-ssh-armhf
    CROSS_TARGET_ARCH: armhf
    DOCKERFILE_FOLDER: "${DEBIAN_CROSS_TOOLCHAINS_FOLDER}/${SSH_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_CROSS_TOOLCHAINS_FOLDER}/${SSH_FOLDER}/"
  needs: ["build-armhf-toolchain"]

build-arm64-toolchain:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes: &arm64-toolchain-changes
        - gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_CROSS_TOOLCHAINS_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_CROSS_TOOLCHAINS_FOLDER}/${SSH_FOLDER}/*
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes: *arm64-toolchain-changes
  before_script:
    - export DEBIAN_POINT_RELEASE="${DEBIAN_POINT_RELEASE}"
  variables:
    BUILD_FOR_ARM_AMD64: "true"
    CROSS_COMPILER: aarch64-linux-gnu
    CROSS_TARGET_ARCH: arm64
    IMAGE_NAME: debian-cross-toolchain-arm64
    DOCKERFILE_FOLDER: "${DEBIAN_CROSS_TOOLCHAINS_FOLDER}/${BASE_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_CROSS_TOOLCHAINS_FOLDER}/${BASE_FOLDER}/"
  needs: []

build-arm64-toolchain-imx8:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes: &arm64-toolchain-changes
        - gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_CROSS_TOOLCHAINS_FOLDER}/${BASE_FOLDER}/*
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes: *arm64-toolchain-changes
  before_script:
    - export DEBIAN_POINT_RELEASE="${DEBIAN_POINT_RELEASE}"
  variables:
    BUILD_FOR_ARM_AMD64: "true"
    CROSS_COMPILER: aarch64-linux-gnu
    CROSS_TARGET_ARCH: arm64
    IMAGE_NAME: debian-cross-toolchain-arm64
    DOCKERFILE_FOLDER: "${DEBIAN_CROSS_TOOLCHAINS_FOLDER}/${BASE_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_CROSS_TOOLCHAINS_FOLDER}/${BASE_FOLDER}/"
    ACCEPT_FSL_EULA: 1
  needs: []

build-arm64-toolchain-ssh:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes: &arm64-toolchain-ssh-changes
        - gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_CROSS_TOOLCHAINS_FOLDER}/${SSH_FOLDER}/*
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes: *arm64-toolchain-ssh-changes
  variables:
    BUILD_FOR_ARM_AMD64: "true"
    IMAGE_NAME: debian-cross-toolchain-ssh-arm64
    CROSS_TARGET_ARCH: arm64
    DOCKERFILE_FOLDER: "${DEBIAN_CROSS_TOOLCHAINS_FOLDER}/${SSH_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_CROSS_TOOLCHAINS_FOLDER}/${SSH_FOLDER}/"
  needs: [build-arm64-toolchain]

## rt-validation

build-rt-tests:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes: &rt-tests-changes
        - gitlab-ci.yml
        - ci-scripts/**/*
        - ${RT_VALIDATION_FOLDER}/${RT_TESTS_FOLDER}/*
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes: *rt-tests-changes
  before_script:
    - export DEBIAN_POINT_RELEASE="${DEBIAN_POINT_RELEASE}"
  variables:
    BUILD_FOR_ARM_V7: "true"
    BUILD_FOR_ARM_V8: "true"
    IMAGE_NAME: rt-tests
    DOCKERFILE_FOLDER: "${RT_VALIDATION_FOLDER}/${RT_TESTS_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${RT_VALIDATION_FOLDER}/${RT_TESTS_FOLDER}/"
  needs: []

build-stress-tests:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes: &stress-tests-changes
        - gitlab-ci.yml
        - ci-scripts/**/*
        - ${RT_VALIDATION_FOLDER}/${STRESS_TESTS_FOLDER}/*
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes: *stress-tests-changes
  before_script:
    - export DEBIAN_POINT_RELEASE="${DEBIAN_POINT_RELEASE}"
  variables:
    BUILD_FOR_ARM_V7: "true"
    BUILD_FOR_ARM_V8: "true"
    IMAGE_NAME: stress-tests
    DOCKERFILE_FOLDER: "${RT_VALIDATION_FOLDER}/${STRESS_TESTS_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${RT_VALIDATION_FOLDER}/${STRESS_TESTS_FOLDER}/"
  needs: []

## am62

build-base-am62:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: &am62-changes
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/**/*
  variables:
    BUILD_FOR_ARM_V8: "true"
    IMAGE_NAME: debian-am62
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${BASE_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/"

build-wayland-base-am62:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *am62-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: debian-am62
    IMAGE_NAME: wayland-base-am62
    ACCEPT_FSL_EULA: 1
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${WAYLAND_BASE_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${WAYLAND_BASE_FOLDER}/"
  needs:
    - job: build-base-am62
      optional: true

build-weston-am62:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${WESTON_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${WESTON_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *am62-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: wayland-base-am62
    IMAGE_NAME: weston-am62
    ACCEPT_FSL_EULA: 1
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${WESTON_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${WESTON_FOLDER}/"
  needs:
    - job: build-wayland-base-am62
      optional: true

build-graphics-tests-am62:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${TESTS_FOLDER}/${GRAPHICS_TESTS_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *am62-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: wayland-base-am62
    IMAGE_NAME: graphics-tests-am62
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${TESTS_FOLDER}/${GRAPHICS_TESTS_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${TESTS_FOLDER}/${GRAPHICS_TESTS_FOLDER}/"
  needs:
    - job: build-wayland-base-am62
      optional: true

build-weston-touch-calibrator-am62:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${WESTON_TOUCH_CALIBRATOR_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${WESTON_TOUCH_CALIBRATOR_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *am62-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: weston-am62
    IMAGE_NAME: weston-touch-calibrator-am62
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${WESTON_TOUCH_CALIBRATOR_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${WESTON_TOUCH_CALIBRATOR_FOLDER}/"
  needs:
    - job: build-weston-am62
      optional: true

build-qt5-wayland-am62:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${QT5_WAYLAND_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *am62-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: wayland-base-am62
    IMAGE_NAME: qt5-wayland-am62
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${QT5_WAYLAND_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/"
  needs:
    - job: build-wayland-base-am62
      optional: true

build-qt5-wayland-am62-examples:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${QT5_WAYLAND_EXAMPLES_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${QT5_WAYLAND_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *am62-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: qt5-wayland-am62
    IMAGE_NAME: qt5-wayland-examples-am62
    QT5_EXAMPLES_DEBIAN: 1
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${QT5_WAYLAND_EXAMPLES_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/"
  needs:
    - job: build-qt5-wayland-am62
      optional: true

build-qt6-wayland-am62:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${QT6_WAYLAND_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *am62-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: wayland-base-am62
    IMAGE_NAME: qt6-wayland-am62
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${QT6_WAYLAND_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/"
  needs:
    - job: build-wayland-base-am62
      optional: true

build-qt6-wayland-am62-examples:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${QT6_WAYLAND_EXAMPLES_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${QT6_WAYLAND_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *am62-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: qt6-wayland-am62
    IMAGE_NAME: qt6-wayland-examples-am62
    QT6_EXAMPLES_DEBIAN: 1
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${QT6_WAYLAND_EXAMPLES_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/qt-wayland/"
  needs:
    - job: build-qt6-wayland-am62
      optional: true

build-chromium-am62:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${CHROMIUM_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${CHROMIUM_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *am62-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: wayland-base-am62
    IMAGE_NAME: chromium-am62
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${CHROMIUM_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${CHROMIUM_FOLDER}/"
  needs:
    - job: build-wayland-base-am62
      optional: true

build-chromium-tests-am62:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${CHROMIUM_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${TESTS_FOLDER}/${CHROMIUM_AM62_TESTS_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${CHROMIUM_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${TESTS_FOLDER}/${CHROMIUM_AM62_TESTS_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *am62-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: chromium-am62
    IMAGE_NAME: chromium-tests-am62
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${TESTS_FOLDER}/${CHROMIUM_TESTS_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${TESTS_FOLDER}/${CHROMIUM_TESTS_FOLDER}/"
  needs:
    - job: build-chromium-am62
      optional: true

build-cog-am62:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes:
        - .gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${COG_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${COG_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *am62-changes
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: wayland-base-am62
    IMAGE_NAME: cog-am62
    DOCKERFILE_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${COG_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${COG_FOLDER}/"
  needs:
    - job: build-wayland-base-am62
      optional: true

build-dotnet-8-am62:
  retry: 2
  extends: .docker-build
  rules: &dotnet-8-am62-rules
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes: &dotnet-8-am62-changes
        - gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_BASE_FOLDER}/*
        - ${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_DEBUG_FOLDER}/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *am62-changes
  before_script:
    - . ./ci-scripts/build/export-dotnet-build-args.sh ./ci-scripts/container-versions/dotnet-8.yml dotnet8-am62
    - export DEBIAN_POINT_RELEASE="${DEBIAN_POINT_RELEASE}"
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: debian-am62
    IMAGE_NAME: dotnet8-am62
    DOTNET_RUNTIME: dotnet
    DOCKERFILE_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_BASE_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_BASE_FOLDER}/"
  needs: ["build-base-am62"]

build-dotnet-8-asp-am62:
  retry: 2
  extends: .docker-build
  rules: &dotnet-8-asp-am62-rules
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes: *dotnet-8-am62-changes
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *am62-changes
  before_script:
    - . ./ci-scripts/build/export-dotnet-build-args.sh ./ci-scripts/container-versions/dotnet-8.yml aspdotnet8-am62
    - export DEBIAN_POINT_RELEASE="${DEBIAN_POINT_RELEASE}"
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: debian-am62
    IMAGE_NAME: aspdotnet8-am62
    DOTNET_RUNTIME: aspnetcore
    DOCKERFILE_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_BASE_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_BASE_FOLDER}/"
  needs: ["build-base-am62"]

build-dotnet-8-wayland-am62:
  retry: 2
  extends: .docker-build
  rules:
    - if: $CI_WORLD_TEST == "true"
      when: never
    - if: $CI_WORLD_REBUILD == "true"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $CI_PIPELINE_SOURCE == "push"
      variables:
        REGISTRY_NAMESPACE: $PROJECT_SETTING_REGISTRY_NAMESPACE
      changes: &dotnet-8-wayland-am62-changes
        - gitlab-ci.yml
        - ci-scripts/**/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${SUPPORT_FILES_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${BASE_FOLDER}/*
        - ${DEBIAN_DOCKER_IMAGES_FOLDER}/${AM62_FOLDER}/${WAYLAND_BASE_FOLDER}/*
        - ${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/**/*
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
      changes: *am62-changes
  before_script:
    - . ./ci-scripts/build/export-dotnet-build-args.sh ./ci-scripts/container-versions/dotnet-8.yml dotnet8-wayland-am62
    - export DEBIAN_POINT_RELEASE="${DEBIAN_POINT_RELEASE}"
  variables:
    BUILD_FOR_ARM_V8: "true"
    BASE_IMAGE_NAME: dotnet8-am62
    BASE_IMAGE_NAME_WAYLAND: wayland-base-am62
    IMAGE_NAME: dotnet8-wayland-am62
    DOCKERFILE_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_WAYLAND_BASE_FOLDER}/"
    DOCKERFILE_BUILD_CONTEXT_FOLDER: "${DEBIAN_DOTNET_DEVELOPMENT_IMAGES_FOLDER}/${DOTNET_WAYLAND_BASE_FOLDER}/"
  needs: ["build-dotnet-8-am62", "build-wayland-base-am62"]

.shellcheck:
  image: koalaman/shellcheck-alpine:latest
  script: find . -type f -iname "*.sh" | xargs -r shellcheck --severity=${SHELLCHECK_SEVERITY}

shell-errors:
  extends: .shellcheck
  variables:
    SHELLCHECK_SEVERITY: "error"

shell-warnings:
  extends: .shellcheck
  variables:
    SHELLCHECK_SEVERITY: "warning"

shell-format:
  image: mvdan/shfmt:v3.2.0-alpine
  script:
    - find . -type f -iname "*.sh" | xargs -r shfmt -i 2 -ci -d

check-line-breaks:
  image: alpine:latest
  before_script:
    - apk update
    - apk add file
  script: ./ci-scripts/lint/lint-line-breaks.sh
